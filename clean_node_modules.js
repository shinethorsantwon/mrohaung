const ftp = require("basic-ftp");
const fs = require("fs");

async function cleanupNodeModules() {
    const client = new ftp.Client();
    try {
        await client.access({
            host: "193.203.173.82",
            user: "u860480593.mrohaung.com",
            password: "SBCsmFTP1234!@#$",
            secure: false
        });

        console.log("Cleaning problematic node_modules...");

        try {
            await client.removeDir("/public_html/node_modules/sharp");
            console.log("âœ… Removed sharp (Linux binary mismatch likely)");
        } catch (e) {
            console.log("sharp not found or error: " + e.message);
        }

        try {
            await client.removeDir("/public_html/node_modules/better-sqlite3");
            console.log("âœ… Removed better-sqlite3 (Linux binary mismatch likely)");
        } catch (e) {
            console.log("better-sqlite3 not found or error: " + e.message);
        }

        console.log("ðŸ”„ Triggering Server Restart...");
        await client.ensureDir("/public_html/tmp");
        fs.writeFileSync("restart_cleanup.txt", "restart " + Date.now());
        await client.uploadFrom("restart_cleanup.txt", "/public_html/tmp/restart.txt");
        fs.unlinkSync("restart_cleanup.txt");

    } finally {
        client.close();
    }
}

cleanupNodeModules();
